# Google Slides Integration

**One-Line Summary:** Profile-scoped, user-scoped Google OAuth2 flow with encrypted credential storage and LLM-powered HTML-to-Google-Slides conversion.

---

## 1. Overview

The Google Slides integration allows users to export their AI-generated slide decks directly to Google Slides presentations. It extends the existing PPTX export with a cloud-native alternative that produces editable Google Slides.

Key design decisions:
- **Per-profile credentials** â€” Each configuration profile stores its own Google OAuth `credentials.json`, encrypted at rest.
- **Per-user tokens** â€” OAuth tokens are scoped to the combination of (user, profile) so multiple users share the same client credentials but maintain their own authorization.
- **DB-backed storage** â€” No files on disk; all secrets live in PostgreSQL/Lakebase, encrypted with Fernet symmetric encryption.
- **LLM code-gen approach** â€” Same architecture as PPTX export: an LLM generates Python code that calls the Google Slides API, which is then executed server-side.

---

## 2. Architecture

```
Frontend (ConfigTabs â†’ GoogleSlidesAuthForm)
  â”‚
  â”œâ”€ Upload credentials.json â”€â”€â–º POST /api/settings/profiles/{id}/google-credentials
  â”‚                                 â””â”€ validates â†’ encrypts â†’ stores in config_profiles
  â”‚
  â”œâ”€ Authorize (popup) â”€â”€â”€â”€â”€â”€â”€â”€â–º GET /api/export/google-slides/auth/url
  â”‚                                 â””â”€ builds Flow from decrypted creds â†’ returns consent URL
  â”‚   Google consent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º GET /api/export/google-slides/auth/callback
  â”‚                                 â””â”€ exchanges code â†’ encrypts token â†’ stores in google_oauth_tokens
  â”‚
  â””â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º POST /api/export/google-slides
                                    â””â”€ builds auth â†’ fetches slides â†’ LLM converts â†’ creates presentation
```

### Data Flow

1. **Admin** uploads `credentials.json` via the Google Slides tab in profile settings.
2. **Each user** clicks "Authorize" to complete the OAuth consent flow in a popup. The resulting token is encrypted and stored per-user.
3. **Export** builds an authenticated Google API client, creates a blank presentation, and processes each slide through the LLM converter.

---

## 3. Database Schema

### New Column: `config_profiles.google_credentials_encrypted`

```sql
ALTER TABLE config_profiles
ADD COLUMN IF NOT EXISTS google_credentials_encrypted TEXT;
```

Stores the Fernet-encrypted contents of `credentials.json` for the profile. `NULL` if not configured.

### New Table: `google_oauth_tokens`

```sql
CREATE TABLE google_oauth_tokens (
    id              SERIAL PRIMARY KEY,
    user_identity   VARCHAR(255) NOT NULL,
    profile_id      INTEGER NOT NULL REFERENCES config_profiles(id) ON DELETE CASCADE,
    token_encrypted TEXT NOT NULL,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (user_identity, profile_id)
);
```

| Column | Description |
|--------|-------------|
| `user_identity` | Databricks username (email) or `"local_dev"` |
| `profile_id` | FK to the profile whose client credentials were used |
| `token_encrypted` | Fernet-encrypted JSON token (access, refresh, expiry) |

The composite unique constraint ensures one token per user per profile.

### Column Migration

`_run_column_migrations()` in `src/core/database.py` runs `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` on startup. This is idempotent and safe for repeated execution.

---

## 4. Encryption

**Module:** `src/core/encryption.py`

Uses Fernet symmetric encryption from the `cryptography` library.

| Function | Purpose |
|----------|---------|
| `get_encryption_key()` | Returns the 32-byte Fernet key (cached). Reads from `GOOGLE_OAUTH_ENCRYPTION_KEY` env var, falls back to `.encryption_key` file, or generates and persists a new key. |
| `encrypt_data(plaintext)` | Encrypts a string and returns a base64-encoded ciphertext string. |
| `decrypt_data(ciphertext)` | Decrypts. Raises `InvalidToken` if the key doesn't match. |

**Key management:**
- **Production:** Set `GOOGLE_OAUTH_ENCRYPTION_KEY` environment variable (base64-encoded 32-byte key generated by `Fernet.generate_key()`). The app **will not start** if this variable is missing in production (`ENVIRONMENT=production`); a `RuntimeError` is raised at first use.
- **Local dev:** The key is auto-generated and persisted to `.encryption_key` (gitignored).

Generate a production key:
```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

**Stale key handling:** If a token or credential cannot be decrypted (e.g., after key rotation), the system silently deletes the stale record and prompts the user to re-authorize.

---

## 5. API Endpoints

### Credential Management (`/api/settings/profiles/{profile_id}/google-credentials`)

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/{profile_id}/google-credentials` | Upload `credentials.json` file. Validates structure, encrypts, stores. |
| `GET` | `/{profile_id}/google-credentials/status` | Returns `{"has_credentials": bool}`. Attempts decryption; clears stale data on failure. |
| `DELETE` | `/{profile_id}/google-credentials` | Removes stored credentials from the profile. Returns 204. |

**Validation:** The uploaded JSON must contain either an `"installed"` or `"web"` top-level key with `client_id` and `client_secret`.

### OAuth Flow (`/api/export/google-slides/auth`)

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/auth/status?profile_id=N` | Returns `{"authorized": bool}`. Gracefully returns `false` on any error. |
| `GET` | `/auth/url?profile_id=N` | Generates and returns the Google OAuth consent URL. |
| `GET` | `/auth/callback?code=...&profile_id=N` | Exchanges auth code for tokens, encrypts, stores. Returns HTML that notifies the opener window. |

### Export (`/api/export/google-slides`)

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/api/export/google-slides` | Exports the slide deck to a new Google Slides presentation. Returns `{presentation_id, presentation_url}`. |

**Request body:**
```json
{
  "session_id": "abc123",
  "profile_id": 1,
  "chart_images": [[{"canvas_id": "chart_0", "base64_data": "data:image/png;base64,..."}]]
}
```

---

## 6. Backend Services

### GoogleSlidesAuth (`src/services/google_slides_auth.py`)

Manages OAuth2 credentials and token lifecycle. Supports two modes:

| Mode | Constructor | Persistence |
|------|-------------|-------------|
| **DB-backed** | `GoogleSlidesAuth.from_profile(profile_id, user_identity, db_session)` | Encrypted in PostgreSQL |
| **File-backed** | `GoogleSlidesAuth(credentials_path=..., token_path=...)` | JSON files on disk |

Key methods:
- `is_authorized()` â€” Checks for valid (or refreshable) token.
- `get_auth_url(redirect_uri)` â€” Generates consent URL.
- `authorize(code, redirect_uri)` â€” Exchanges code for tokens, persists.
- `build_slides_service()` / `build_drive_service()` â€” Returns authenticated Google API clients.

### HtmlToGoogleSlidesConverter (`src/services/html_to_google_slides.py`)

LLM-powered converter following the same pattern as `HtmlToPptxConverterV3`:

1. Creates a blank Google Slides presentation via the API.
2. For each slide, sends the HTML to the LLM with a detailed system prompt.
3. LLM generates Python code that calls `slides_service.presentations().batchUpdate()`.
4. Code is executed server-side with sanitization (smart quote replacement, function wrapping, import injection).
5. On failure, retries once with error context. Falls back to a placeholder text box.

### Prompts (`src/services/google_slides_prompts_defaults.py`)

Shared rules cover:
- Slide dimensions (16:9 widescreen, 10" x 5.625")
- Overflow prevention with strict bounds
- Font size maximums per element type
- Metric card, table, chart, and layout patterns
- Google Slides API patterns (batchUpdate nesting, textRange, shapeProperties)

---

## 7. Frontend Components

### GoogleSlidesAuthForm (`frontend/src/components/config/GoogleSlidesAuthForm.tsx`)

New component rendered as the "Google Slides" tab in `ConfigTabs`. Provides:
- Drag-and-drop file upload for `credentials.json`
- Status indicators (uploaded / not configured)
- Upload / replace / remove actions
- "Authorize with Google" button (opens popup)
- Authorization status (authorized / not authorized)
- Help text with instructions for obtaining credentials from Google Cloud Console

### ConfigTabs (`frontend/src/components/config/ConfigTabs.tsx`)

Added tab `{ id: 'google_slides', label: 'Google Slides', icon: 'ðŸ“Š' }` to the `allTabs` array.

### ProfileDetail (`frontend/src/components/config/ProfileDetail.tsx`)

Read-only view mode now displays Google Slides status:
- Credentials: "Uploaded" (green) or "Not configured" (gray)
- Authorization: "Authorized" (green) or "Not authorized" (gray) or "â€”" (if no credentials)

### SlidePanel (`frontend/src/components/SlidePanel/SlidePanel.tsx`)

`handleExportGoogleSlides` now passes `profileId` to all Google Slides API calls.

### API Services

- `frontend/src/api/config.ts` â€” `uploadGoogleCredentials()`, `getGoogleCredentialsStatus()`, `deleteGoogleCredentials()`
- `frontend/src/services/api.ts` â€” `checkGoogleSlidesAuth(profileId)`, `getGoogleSlidesAuthUrl(profileId)`, `exportToGoogleSlides(sessionId, profileId, ...)`

---

## 8. Test Coverage

| Test File | Tests | Coverage |
|-----------|-------|----------|
| `tests/unit/test_encryption.py` | 4 | Encrypt/decrypt roundtrip, wrong-key rejection, key sources |
| `tests/unit/config/test_google_oauth.py` | 26 | Models, credentials API, `from_profile`, auth service, auth endpoint |
| `tests/unit/test_database_migrations.py` | 2 | Column migration idempotency |
| `tests/unit/test_google_slides_converter.py` | 17 | Static methods: extract, strip fences, chart notes, code prep, image save |
| `tests/unit/test_prompts_defaults.py` | 7 | PPTX + Google Slides prompt constant validation |
| `tests/unit/test_app_wiring.py` | 8 | Model registration, router exports, route registration |
| `tests/unit/test_google_slides_routes.py` | 14 | Auth endpoints, export endpoint, helper functions |

Run all tests:
```bash
pytest tests/unit/ -v --ignore=tests/unit/test_chart_persistence.py \
  --ignore=tests/unit/test_deck_integrity.py \
  --ignore=tests/unit/test_llm_edit_responses.py
```

---

## 9. Configuration & Setup

### Google Cloud Console Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/).
2. Create a project (or use an existing one).
3. Enable the **Google Slides API** and **Google Drive API**.
4. Go to Credentials â†’ Create OAuth 2.0 Client ID (Desktop app).
5. Download the `credentials.json` file.
6. Upload it in the profile's Google Slides tab.

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `GOOGLE_OAUTH_ENCRYPTION_KEY` | **Yes** (production) | Fernet key for encrypting credentials/tokens. App raises `RuntimeError` on startup if missing in production. |

### Dependencies

Added to `requirements.txt`:
```
google-api-python-client>=2.100.0
google-auth-oauthlib>=1.2.0
google-auth-httplib2>=0.2.0
cryptography>=42.0.0
```

---

## 10. Cross-References

- [Export Features](./export-features.md) â€” PDF and PPTX export details
- [Backend Overview](./backend-overview.md) â€” FastAPI architecture and API surface
- [Database Configuration](./database-configuration.md) â€” Schema details
- [Frontend Overview](./frontend-overview.md) â€” React components and state management

